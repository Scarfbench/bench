# Justfile for order-quarkus
APP_NAME := "order-quarkus"
QUARKUS_IMAGE := "quarkus/order-quarkus:latest"
QUARKUS_PORT := "8082"
HOST_PORT := "8082"

build:
    docker build -f src/main/docker/Dockerfile.native -t {{QUARKUS_IMAGE}} .
    @echo "[INFO] Built image: {{QUARKUS_IMAGE}}"

rebuild:
    docker build --no-cache -f src/main/docker/Dockerfile.native -t {{QUARKUS_IMAGE}} .
    @echo "[INFO] Rebuilt image (no cache): {{QUARKUS_IMAGE}}"

up: build
    @if docker ps --all --quiet --filter name=^/{{APP_NAME}}$ | grep -q .; then \
        echo "[INFO] Removing existing container"; \
        docker rm -f {{APP_NAME}} >/dev/null; \
    fi
    docker run -i --rm -p {{HOST_PORT}}:{{QUARKUS_PORT}} {{QUARKUS_IMAGE}}

logs:
    docker logs -f {{APP_NAME}}

down:
    - docker rm -f {{APP_NAME}}
    @echo "[INFO] Container removed (if it existed)"

test-smoke:
    ./mvnw quarkus:dev &
    sleep 10
    python smoke.py
    pkill -f 'quarkus:dev'

test-docker-smoke: up
    python smoke.py

local:
    ./mvnw clean quarkus:dev