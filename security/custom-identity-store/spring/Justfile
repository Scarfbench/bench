APP_NAME       := "custom-identity-store"
LIBERTY_IMAGE   := "custom-identity-store:latest"
LIBERTY_PORT    := "9080"               # Liberty internal HTTP

build:
	docker build -f Dockerfile -t {{LIBERTY_IMAGE}} .
	@echo "[INFO] Built image: {{LIBERTY_IMAGE}}"

rebuild:
	docker build --no-cache -f Dockerfile -t {{LIBERTY_IMAGE}} .
	@echo "[INFO] Rebuilt image (no cache): {{LIBERTY_IMAGE}}"

up: build
	@if docker ps --all --quiet --filter name=^/custom-identity-store$ | grep -q .; then \
		echo "[INFO] Removing existing container"; \
		docker rm -f custom-identity-store >/dev/null; \
	fi
	docker run -d --name custom-identity-store custom-identity-store:latest 
	@echo "[INFO] Started custom-identity-store, waiting for app to start..."
	@until docker logs custom-identity-store 2>&1 | grep -q "Started"; do sleep 1; done
	@echo "[INFO] Spring Boot app started."

logs:
	docker logs -f custom-identity-store

down:
	- docker rm -f custom-identity-store
	@echo "[INFO] Container removed (if it existed)"

test: up
    @docker exec {{APP_NAME}} sh -c 'python3 /app/smoke.py'

smoke: up
    @docker exec {{APP_NAME}} sh -c 'python3 /app/smoke.py'

local:
	./mvnw clean package liberty:run