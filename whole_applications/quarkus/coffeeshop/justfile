# Quarkus Coffeeshop Project Justfile
# Run `just` to see available recipes

# Set shell
set shell := ["bash", "-c"]

# Default recipe - shows available commands
default:
    @just --list

# Start PostgreSQL database for development
db-start:
    @echo "Starting PostgreSQL database for development..."
    docker run --name coffeeshop-pg \
      -e POSTGRES_PASSWORD=redhat-21 \
      -e POSTGRES_DB=coffeeshopdb \
      -p 5432:5432 \
      -v coffeeshop_pgdata:/var/lib/postgresql/data \
      -v "$$PWD/infra/postgres/init":/docker-entrypoint-initdb.d:ro,Z \
      -d postgres:15

# Stop and remove PostgreSQL database container
db-stop:
    @echo "Stopping and removing PostgreSQL database container..."
    docker stop coffeeshop-pg || echo "Container not running"
    docker rm coffeeshop-pg || echo "Container not found"

# Run in development mode (with hot reload)
dev: db-start
    @echo "Starting Quarkus in development mode..."
    ./mvnw quarkus:dev

# Start application with Docker Compose
up: down
    @echo "Starting application with Docker Compose..."
    docker-compose up -d

# Stop Docker Compose services
down:
    @echo "Stopping Docker Compose services..."
    docker-compose down

# View Docker Compose logs
logs:
    @echo "Viewing application logs..."
    docker-compose logs -f

# Restart Docker Compose services
restart:
    @echo "Restarting services..."
    docker-compose restart

# Build and deploy (build + docker-build + up)
deploy: up
    @echo "Application deployed successfully!"
    @echo ""
    @echo "Access the application at: http://localhost:9080/"
    @echo "PostgreSQL available at: localhost:5432"

# Show application status
status:
    @echo "Docker Compose services status:"
    docker-compose ps
    @echo ""
    @echo "Docker images:"
    docker images | grep coffeeshop

# View application in browser (requires xdg-open)
open:
    @echo "Opening application in browser..."
    xdg-open http://localhost:8080/ || echo "Please open http://localhost:8080/ manually"

# Complete dedeployment - stops containers, removes images, and frees all resources
dedeploy:
    @echo "Dedeploying application..."
    @echo "Stopping all containers..."
    docker-compose down -v || echo "No containers to stop"
    @echo "Removing Docker image..."
    docker rmi coffeeshop-quarkus:latest || echo "Image not found"
    @echo "Removing stopped containers and freeing ports..."
    docker container prune -f
    @echo "Cleaning up networks..."
    docker network prune -f
    @echo "Dedeployment complete - all ports released!"

# Run Playwright-based smoke tests inside the running container
# This assumes the application is running via docker-compose
# This does:
#   cd smoke
#   uv sync
#   uv run playwright install chromium --only-shell
#   uv run playwright install-deps chromium
#   uv run smoke.py
smoke:
	@echo "[INFO] Running smoke tests inside container..."
	@CONTAINER_NAME=$$(docker-compose ps -q coffeeshop-quarkus 2>/dev/null || echo ""); \
	if [ -z "$$CONTAINER_NAME" ]; then \
		echo "[ERROR] Container not running. Please run 'just up' first."; \
		exit 1; \
	fi; \
	docker exec $$CONTAINER_NAME bash -lc "cd smoke && uv sync && uv run playwright install chromium --only-shell && uv run playwright install-deps chromium && uv run smoke.py"

test: smoke

# Build Docker image for smoke testing (single container mode)
build:
	docker build -f Dockerfile -t coffeeshop-quarkus:latest .
	@echo "[INFO] Built image: coffeeshop-quarkus:latest"

# Start single container for smoke testing
up-single: build
	- docker rm -f coffeeshop-quarkus-single 2>/dev/null || true
	docker run -d --name coffeeshop-quarkus-single -p 8080:8080 coffeeshop-quarkus:latest
	@echo "[INFO] Started coffeeshop-quarkus-single container..."
	@echo "[INFO] Waiting for application to start..."
	@while true; do \
		if docker logs coffeeshop-quarkus-single 2>&1 | grep -q "started in"; then \
			echo "[INFO] Application is ready!"; \
			break; \
		fi; \
		sleep 1; \
	done

# Run smoke tests on single container
smoke-single: up-single
	@echo "[INFO] Running smoke tests inside container coffeeshop-quarkus-single..."
	docker exec coffeeshop-quarkus-single bash -lc "cd smoke && uv sync && uv run playwright install chromium --only-shell && uv run playwright install-deps chromium && uv run smoke.py"
	- docker rm -f coffeeshop-quarkus-single

# Show project information
info:
	@echo "Quarkus Coffeeshop Project Information"
	@echo "======================================"
	@echo "Project: coffeeshop-quarkus (Quarkus Majestic Monolith)"
	@echo "Version: 1.0.0-SNAPSHOT"
	@echo "Java Version: 17"
	@echo "Framework: Quarkus 2.14.1.Final"
	@echo ""
	@echo "URLs when running:"
	@echo "  Application: http://localhost:9080/"
	@echo "  PostgreSQL: localhost:5432"
	@echo "  Redpanda: localhost:9092"
	@echo ""
	@echo "Key files:"
	@echo "  JAR file: target/quarkuscoffeeshop-majestic-monolith-1.0.0-SNAPSHOT.jar"
	@echo "  Source: src/main/java/"
	@echo "  Resources: src/main/resources/"