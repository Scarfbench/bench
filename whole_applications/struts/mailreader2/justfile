# Struts 2 Mail Reader Project Justfile
# Run `just` to see available recipes

# Set shell
set shell := ["bash", "-c"]

# Default recipe - shows available commands
default:
    @just --list

# Build the WAR file using Maven
build:
    @echo "Building the mailreader2 WAR file..."
    mvn clean package

# Clean build artifacts
clean:
    @echo "Cleaning build artifacts..."
    mvn clean

# Compile without packaging
compile:
    @echo "Compiling Java sources..."
    mvn compile

# Run tests
test:
    @echo "Running tests..."
    mvn test

# Run the application locally with Jetty
run:
    @echo "Starting application with Jetty..."
    mvn clean jetty:run

# Build Docker image
docker-build:
    @echo "Building Docker image..."
    just build
    docker build -t mailreader2:latest .

# Run Docker container
docker-run:
    @echo "Starting application with Docker..."
    docker run -p 9347:9347 --name mailreader2-container mailreader2:latest

# Run Docker container in detached mode
up:
    @echo "Starting application with Docker (detached)..."
    docker run -d -p 9347:9347 --name mailreader2-container mailreader2:latest

# Stop Docker container
down:
    @echo "Stopping Docker container..."
    docker stop mailreader2-container || echo "Container not running"

# View Docker container logs
logs:
    @echo "Viewing application logs..."
    docker logs -f mailreader2-container

# Restart Docker container
restart:
    @echo "Restarting container..."
    docker restart mailreader2-container

# Build and deploy (build + docker-build + up)
deploy: build docker-build up
    @echo "Application deployed successfully!"
    @echo ""
    @echo "Access the application at: http://localhost:9347/mailreader2/"

# Show application status
status:
    @echo "Docker container status:"
    docker ps | grep mailreader2 || echo "No mailreader2 containers running"
    @echo ""
    @echo "Docker images:"
    docker images | grep mailreader2

# View application in browser (requires open on macOS)
open:
    @echo "Opening application in browser..."
    open http://localhost:9347/mailreader2/ || echo "Please open http://localhost:9347/mailreader2/ manually"

# Complete dedeployment - stops containers, removes images, and frees all resources
dedeploy:
    @echo "dedeploying application..."
    @echo "Stopping container..."
    docker stop mailreader2-container || echo "No container to stop"
    @echo "Removing container..."
    docker rm mailreader2-container || echo "Container not found"
    @echo "Removing Docker image..."
    docker rmi mailreader2:latest || echo "Image not found"
    @echo "Cleaning up stopped containers..."
    docker container prune -f
    @echo "Cleaning up networks..."
    docker network prune -f
    @echo "dedeployment complete - all ports released!"

# Clean Docker resources
docker-clean:
    @echo "Cleaning Docker resources..."
    docker stop mailreader2-container || echo "Container not running"
    docker rm mailreader2-container || echo "Container not found"
    docker rmi mailreader2:latest || echo "Image not found"
    docker system prune -f

# Development workflow - clean, build, and deploy
dev: clean build docker-build up
    @echo "Development environment ready!"
    @echo "Application: http://localhost:9347/mailreader2/"

# Local development workflow - clean and run with Jetty
dev-local: clean run
    @echo "Local development environment starting..."
    @echo "Application will be available at: http://localhost:8080/mailreader2/"

# Show project information
info:
    @echo "Struts 2 Mail Reader Project Information"
    @echo "========================================"
    @echo "Project: mailreader2 (Struts 2 Example)"
    @echo "Version: 2.0.0"
    @echo "Java Version: 17"
    @echo "Framework: Apache Struts 2.7.0.3"
    @echo ""
    @echo "URLs when running:"
    @echo "  Local (Jetty): http://localhost:8080/mailreader2/"
    @echo "  Docker: http://localhost:9347/mailreader2/"
    @echo ""
    @echo "Key files:"
    @echo "  WAR file: target/mailreader2-2.0.0.war"
    @echo "  Source: src/main/java/org/apache/struts/examples/mailreader2/"
    @echo "  Web content: src/main/webapp/"

# Check if Docker is running
check-docker:
    @echo "Checking Docker status..."
    docker --version
    docker ps

# Follow application logs in real-time
tail-logs:
    @echo "Following application logs (Ctrl+C to stop)..."
    docker logs -f mailreader2-container

# Execute bash shell in running container
shell:
    @echo "Opening shell in running container..."
    docker exec -it mailreader2-container bash

# Install dependencies
install:
    @echo "Installing dependencies..."
    mvn install

# Validate the project
validate:
    @echo "Validating project..."
    mvn validate

# Check for dependency updates
dependency-updates:
    @echo "Checking for dependency updates..."
    mvn versions:display-dependency-updates
