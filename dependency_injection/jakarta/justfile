# Jakarta EE Dependency Injection Projects - Master Justfile
# Run `just` to see available recipes

# Set shell
set shell := ["bash", "-c"]

# List of all applications
APPS := "billpayment decorators encoder guessnumber producerfields producermethods simplegreeting"

# Default recipe - shows available commands
default:
    @just --list

# Run a command for a specific application
# Usage: just <app> <command>
# Example: just billpayment build, just simplegreeting deploy
app APP COMMAND *ARGS:
    #!/usr/bin/env bash
    if [[ "{{APPS}}" =~ (^|[[:space:]])"{{APP}}"($|[[:space:]]) ]]; then
        echo "Running '{{COMMAND}}' for {{APP}}..."
        just --working-directory "{{APP}}" --justfile "{{APP}}/justfile" "{{COMMAND}}" {{ARGS}}
    else
        echo "Error: Unknown application '{{APP}}'"
        echo "Available apps: {{APPS}}"
        exit 1
    fi

# Shorter aliases for common patterns
# Usage: just billpayment build
billpayment *ARGS: (app "billpayment" ARGS)
decorators *ARGS: (app "decorators" ARGS)  
encoder *ARGS: (app "encoder" ARGS)
guessnumber *ARGS: (app "guessnumber" ARGS)
producerfields *ARGS: (app "producerfields" ARGS)
producermethods *ARGS: (app "producermethods" ARGS)
simplegreeting *ARGS: (app "simplegreeting" ARGS)

# Build all applications
build-all:
    @echo "Building all applications..."
    @for app in {{APPS}}; do \
        echo "Building $app..."; \
        just --working-directory "$app" --justfile "$app/justfile" build; \
    done

# Deploy all applications
deploy-all:
    @echo "Deploying all applications..."
    @for app in {{APPS}}; do \
        echo "Deploying $app..."; \
        just --working-directory "$app" --justfile "$app/justfile" deploy; \
    done

# dedeploy all applications
dedeploy-all:
    @echo "dedeploying all applications..."
    @for app in {{APPS}}; do \
        echo "dedeploying $app..."; \
        just --working-directory "$app" --justfile "$app/justfile" dedeploy; \
    done

# Show status of all applications
status-all:
    @echo "Status of all applications:"
    @echo "=========================="
    @for app in {{APPS}}; do \
        echo ""; \
        echo "--- $app ---"; \
        just --working-directory "$app" --justfile "$app/justfile" status; \
    done

# Clean all applications
clean-all:
    @echo "Cleaning all applications..."
    @for app in {{APPS}}; do \
        echo "Cleaning $app..."; \
        just --working-directory "$app" --justfile "$app/justfile" clean; \
    done

# Show information about all applications with their ports
info:
    @echo "Jakarta EE Dependency Injection Projects"
    @echo "========================================"
    @echo ""
    @echo "Application URLs (when running):"
    @echo "  billpayment:     http://localhost:8080/billpayment/     (Admin: http://localhost:4848)"
    @echo "  decorators:      http://localhost:8081/decorators/      (Admin: http://localhost:4849)"
    @echo "  encoder:         http://localhost:8082/encoder/         (Admin: http://localhost:4850)"
    @echo "  guessnumber:     http://localhost:8083/guessnumber-cdi/ (Admin: http://localhost:4851)"
    @echo "  producerfields:  http://localhost:8084/producerfields/  (Admin: http://localhost:4852)"
    @echo "  producermethods: http://localhost:8085/producermethods/ (Admin: http://localhost:4853)"
    @echo "  simplegreeting:  http://localhost:8086/simplegreeting/  (Admin: http://localhost:4854)"
    @echo ""
    @echo "Usage Examples:"
    @echo "  just billpayment build      - Build billpayment"
    @echo "  just simplegreeting deploy  - Deploy simplegreeting"
    @echo "  just encoder logs          - View encoder logs"
    @echo "  just decorators dedeploy   - dedeploy decorators"
    @echo ""
    @echo "Bulk commands:"
    @echo "  just build-all     - Build all applications"
    @echo "  just deploy-all    - Deploy all applications"
    @echo "  just dedeploy-all  - dedeploy all applications"
    @echo "  just status-all    - Show status of all applications"
    @echo "  just clean-all     - Clean all applications"

# Development workflow - build and deploy all
dev-all: clean-all build-all deploy-all
    @echo "All applications deployed!"
    @echo ""
    @just info

# Open all applications in browser
open-all:
    @echo "Opening all applications in browser..."
    @for app in {{APPS}}; do \
        echo "Opening $app..."; \
        just --working-directory "$app" --justfile "$app/justfile" open; \
        sleep 1; \
    done

# Quick health check for all applications
health-check:
    @echo "Health check for all applications:"
    @echo "================================="
    @echo "billpayment:     $(curl -s -o /dev/null -w '%{http_code}' http://localhost:8080/billpayment/ || echo 'DOWN')"
    @echo "decorators:      $(curl -s -o /dev/null -w '%{http_code}' http://localhost:8081/decorators/ || echo 'DOWN')"
    @echo "encoder:         $(curl -s -o /dev/null -w '%{http_code}' http://localhost:8082/encoder/ || echo 'DOWN')"
    @echo "guessnumber:     $(curl -s -o /dev/null -w '%{http_code}' http://localhost:8083/guessnumber-cdi/ || echo 'DOWN')"
    @echo "producerfields:  $(curl -s -o /dev/null -w '%{http_code}' http://localhost:8084/producerfields/ || echo 'DOWN')"
    @echo "producermethods: $(curl -s -o /dev/null -w '%{http_code}' http://localhost:8085/producermethods/ || echo 'DOWN')"
    @echo "simplegreeting:  $(curl -s -o /dev/null -w '%{http_code}' http://localhost:8086/simplegreeting/ || echo 'DOWN')"

# Run any command on all applications
all COMMAND *ARGS:
    @echo "Running '{{COMMAND}}' on all applications..."
    @for app in {{APPS}}; do \
        echo "Running '{{COMMAND}}' for $app..."; \
        just --working-directory "$app" --justfile "$app/justfile" {{COMMAND}} {{ARGS}} || echo "Command failed for $app"; \
    done