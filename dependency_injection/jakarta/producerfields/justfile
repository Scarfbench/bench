# Jakarta EE Producer Fields Project Justfile
# Run `just` to see available recipes

# Set shell
set shell := ["bash", "-c"]

# Default recipe - shows available commands
default:
    @just --list

# Build the WAR file using Maven
build:
    @echo "Building the producerfields WAR file..."
    ./mvnw clean package

# Clean build artifacts
clean:
    @echo "Cleaning build artifacts..."
    ./mvnw clean

# Compile without packaging
compile:
    @echo "Compiling Java sources..."
    ./mvnw compile

# Run tests
test:
    @echo "Running tests..."
    ./mvnw test

# Build Docker image
docker-build:
    @echo "Building Docker image..."
    just build
    docker build -t producerfields-glassfish7:latest .

# Start application with Docker Compose
up:
    @echo "Starting application with Docker Compose..."
    docker-compose up -d

# Stop Docker Compose services
down:
    @echo "Stopping Docker Compose services..."
    docker-compose down

# View Docker Compose logs
logs:
    @echo "Viewing application logs..."
    docker-compose logs -f

# Restart Docker Compose services
restart:
    @echo "Restarting services..."
    docker-compose restart

# Build and deploy (build + docker-build + up)
deploy: build docker-build up
    @echo "Application deployed successfully!"
    @echo ""
    @echo "Access the application at: http://localhost:8084/producerfields/"
    @echo "Access GlassFish admin console at: http://localhost:4852/"

# Show application status
status:
    @echo "Docker Compose services status:"
    docker-compose ps
    @echo ""
    @echo "Docker images:"
    docker images | grep producerfields

# View application in browser (requires xdg-open)
open:
    @echo "Opening application in browser..."
    xdg-open http://localhost:8084/producerfields/ || echo "Please open http://localhost:8084/producerfields/ manually"

# Complete dedeployment - stops containers, removes images, and frees all resources
dedeploy:
    @echo "dedeploying application..."
    @echo "Stopping all containers..."
    docker-compose down -v || echo "No containers to stop"
    @echo "Removing Docker image..."
    docker rmi producerfields-glassfish7:latest || echo "Image not found"
    docker rmi producerfields-glassfish:latest || echo "Image not found"
    @echo "Removing stopped containers and freeing ports..."
    docker container prune -f
    @echo "Cleaning up networks..."
    docker network prune -f
    @echo "dedeployment complete - all ports released!"

# Clean Docker resources
docker-clean:
    @echo "Cleaning Docker resources..."
    docker-compose down -v
    docker rmi producerfields-glassfish7:latest || echo "Image not found"
    docker rmi producerfields-glassfish:latest || echo "Image not found"
    docker system prune -f

# Development workflow - clean, build, and deploy
dev: clean build docker-build up
    @echo "Development environment ready!"
    @echo "Application: http://localhost:8084/producerfields/"
    @echo "Admin console: http://localhost:4852/"

# Show project information
info:
    @echo "Jakarta EE Producer Fields Project Information"
    @echo "================================================"
    @echo "Project: producerfields (Jakarta EE CDI Example)"
    @echo "Version: 10-SNAPSHOT"
    @echo "Java Version: 11"
    @echo "Application Server: GlassFish 7"
    @echo ""
    @echo "URLs when running:"
    @echo "  Application: http://localhost:8084/producerfields/"
    @echo "  Admin Console: http://localhost:4852/"
    @echo ""
    @echo "Key files:"
    @echo "  WAR file: target/producerfields.war"
    @echo "  Source: src/main/java/jakarta/"
    @echo "  Web content: src/main/webapp/"

# Check if Docker is running
check-docker:
    @echo "Checking Docker status..."
    docker --version
    docker-compose --version
    docker ps

# Follow application logs in real-time
tail-logs:
    @echo "Following application logs (Ctrl+C to stop)..."
    docker-compose logs -f glassfish

# Execute bash shell in running container
shell:
    @echo "Opening shell in running container..."
    docker-compose exec glassfish bash

# Execute smoke test in running container
smoke-test:
    @echo "Executing smoke test in running container..."
    docker-compose exec glassfish bash -c 'python3 /opt/smoke-test/smoke.py'
